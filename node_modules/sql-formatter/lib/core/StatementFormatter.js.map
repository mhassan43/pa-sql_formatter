{"version":3,"sources":["../../src/core/StatementFormatter.ts"],"names":["StatementFormatter","cfg","params","asTokenFactory","EOF_TOKEN","indentation","Indentation","inlineBlock","InlineBlock","expressionWidth","aliasAs","AliasAs","query","WhitespaceBuilder","statement","tokens","index","length","token","previousReservedToken","type","TokenType","RESERVED_COMMAND","previousCommandToken","formatToken","toString","LINE_COMMENT","formatLineComment","BLOCK_COMMENT","formatBlockComment","currentNewline","checkNewline","formatCommand","RESERVED_BINARY_COMMAND","formatBinaryCommand","RESERVED_DEPENDENT_CLAUSE","formatDependentClause","RESERVED_JOIN_CONDITION","formatJoinCondition","RESERVED_LOGICAL_OPERATOR","formatLogicalOperator","RESERVED_KEYWORD","formatKeyword","BLOCK_START","formatBlockStart","BLOCK_END","formatBlockEnd","RESERVED_CASE_START","formatCaseStart","RESERVED_CASE_END","formatCaseEnd","PARAMETER","formatParameter","OPERATOR","formatOperator","IDENT","STRING","NUMBER","VARIABLE","formatWord","Error","shouldAddBefore","add","show","WS","SPACE","shouldAddAfter","nextTokens","tokensUntilNextCommandOrQueryEnd","isWithinSelect","some","isToken","CASE","multilineLists","inlineWidth","countClauses","tokensString","map","value","join","whitespaceBefore","count","openBlocks","tail","slice","findIndex","undefined","NEWLINE","INDENT","indentComment","comment","replace","getIndent","decreaseTopLevel","tokenLookAhead","increaseTopLevel","isJoin","test","AS","shouldRemove","formatComma","formatQuerySeparator","includes","NO_SPACE","denseOperators","tokenLookBehind","AND","BETWEEN","logicalOperatorNewline","preserveWhitespaceFor","newlineBeforeOpenParen","NO_NEWLINE","beginIfPossible","isActive","increaseBlockLevel","end","formatMultilineBlockEnd","decreaseBlockLevel","SINGLE_INDENT","newlineBeforeCloseParen","get","LIMIT","getPreviousReservedToken","newlineBeforeSemicolon","isTabularToken","showToken","indentStyle","keywordCase","text","toLowerCase","SELECT","n"],"mappings":"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","sourcesContent":["import type { FormatOptions } from 'src/types';\nimport { equalizeWhitespace } from 'src/utils';\n\nimport Indentation from './Indentation';\nimport InlineBlock from './InlineBlock';\nimport Params from './Params';\nimport { isReserved, isCommand, isToken, type Token, TokenType, EOF_TOKEN } from './token';\nimport toTabularFormat from './tabularStyle';\nimport AliasAs from './AliasAs';\nimport AsTokenFactory from './AsTokenFactory';\nimport { type Statement } from './Parser';\nimport { indentString, isTabularStyle } from './config';\nimport WhitespaceBuilder, { WS } from './WhitespaceBuilder';\n\n/** Formats single SQL statement */\nexport default class StatementFormatter {\n  private cfg: FormatOptions;\n  private indentation: Indentation;\n  private inlineBlock: InlineBlock;\n  private aliasAs: AliasAs;\n  private params: Params;\n  private asTokenFactory: AsTokenFactory;\n  private query: WhitespaceBuilder;\n\n  private currentNewline = true;\n  private previousReservedToken: Token = EOF_TOKEN;\n  private previousCommandToken: Token = EOF_TOKEN;\n  private tokens: Token[] = [];\n  private index = -1;\n\n  constructor(cfg: FormatOptions, params: Params, asTokenFactory: AsTokenFactory) {\n    this.cfg = cfg;\n    this.indentation = new Indentation(indentString(cfg));\n    this.inlineBlock = new InlineBlock(this.cfg.expressionWidth);\n    this.aliasAs = new AliasAs(this.cfg.aliasAs, this);\n    this.params = params;\n    this.asTokenFactory = asTokenFactory;\n    this.query = new WhitespaceBuilder(this.indentation);\n  }\n\n  public format(statement: Statement): string {\n    this.tokens = statement.tokens;\n\n    for (this.index = 0; this.index < this.tokens.length; this.index++) {\n      const token = this.tokens[this.index];\n\n      // if token is a Reserved Keyword, Command, Binary Command, Dependent Clause, Logical Operator, CASE, END\n      if (isReserved(token)) {\n        this.previousReservedToken = token;\n        if (token.type === TokenType.RESERVED_COMMAND) {\n          this.previousCommandToken = token;\n        }\n      }\n\n      this.formatToken(token);\n    }\n    return this.query.toString();\n  }\n\n  private formatToken(token: Token): void {\n    switch (token.type) {\n      case TokenType.LINE_COMMENT:\n        return this.formatLineComment(token);\n      case TokenType.BLOCK_COMMENT:\n        return this.formatBlockComment(token);\n      case TokenType.RESERVED_COMMAND:\n        this.currentNewline = this.checkNewline(token);\n        return this.formatCommand(token);\n      case TokenType.RESERVED_BINARY_COMMAND:\n        return this.formatBinaryCommand(token);\n      case TokenType.RESERVED_DEPENDENT_CLAUSE:\n        return this.formatDependentClause(token);\n      case TokenType.RESERVED_JOIN_CONDITION:\n        return this.formatJoinCondition(token);\n      case TokenType.RESERVED_LOGICAL_OPERATOR:\n        return this.formatLogicalOperator(token);\n      case TokenType.RESERVED_KEYWORD:\n        return this.formatKeyword(token);\n      case TokenType.BLOCK_START:\n        return this.formatBlockStart(token);\n      case TokenType.BLOCK_END:\n        return this.formatBlockEnd(token);\n      case TokenType.RESERVED_CASE_START:\n        return this.formatCaseStart(token);\n      case TokenType.RESERVED_CASE_END:\n        return this.formatCaseEnd(token);\n      case TokenType.PARAMETER:\n        return this.formatParameter(token);\n      case TokenType.OPERATOR:\n        return this.formatOperator(token);\n      case TokenType.IDENT:\n      case TokenType.STRING:\n      case TokenType.NUMBER:\n      case TokenType.VARIABLE:\n        return this.formatWord(token);\n      default:\n        throw new Error(`Unexpected token type: ${token.type}`);\n    }\n  }\n\n  /**\n   * Formats word tokens + any potential AS tokens for aliases\n   */\n  private formatWord(token: Token) {\n    if (this.aliasAs.shouldAddBefore(token)) {\n      this.query.add(this.show(this.asTokenFactory.token()), WS.SPACE);\n    }\n\n    this.query.add(this.show(token), WS.SPACE);\n\n    if (this.aliasAs.shouldAddAfter()) {\n      this.query.add(this.show(this.asTokenFactory.token()), WS.SPACE);\n    }\n  }\n\n  /**\n   * Checks if a newline should currently be inserted\n   */\n  private checkNewline(token: Token): boolean {\n    const nextTokens = this.tokensUntilNextCommandOrQueryEnd();\n\n    // auto break if SELECT includes CASE statements\n    if (this.isWithinSelect() && nextTokens.some(isToken.CASE)) {\n      return true;\n    }\n\n    switch (this.cfg.multilineLists) {\n      case 'always':\n        return true;\n      case 'avoid':\n        return false;\n      case 'expressionWidth':\n        return this.inlineWidth(token, nextTokens) > this.cfg.expressionWidth;\n      default: // multilineLists mode is a number\n        return (\n          this.countClauses(nextTokens) > this.cfg.multilineLists ||\n          this.inlineWidth(token, nextTokens) > this.cfg.expressionWidth\n        );\n    }\n  }\n\n  private inlineWidth(token: Token, tokens: Token[]): number {\n    const tokensString = tokens.map(({ value }) => (value === ',' ? value + ' ' : value)).join('');\n    return `${token.whitespaceBefore}${token.value} ${tokensString}`.length;\n  }\n\n  /**\n   * Counts comma-separated clauses (doesn't count commas inside blocks)\n   * Note: There's always at least one clause.\n   */\n  private countClauses(tokens: Token[]): number {\n    let count = 1;\n    let openBlocks = 0;\n    for (const { type, value } of tokens) {\n      if (value === ',' && openBlocks === 0) {\n        count++;\n      }\n      if (type === TokenType.BLOCK_START) {\n        openBlocks++;\n      }\n      if (type === TokenType.BLOCK_END) {\n        openBlocks--;\n      }\n    }\n    return count;\n  }\n\n  /** get all tokens between current token and next Reserved Command or query end */\n  private tokensUntilNextCommandOrQueryEnd(): Token[] {\n    const tail = this.tokens.slice(this.index + 1);\n    return tail.slice(\n      0,\n      tail.length ? tail.findIndex(token => isCommand(token) || token.value === ';') : undefined\n    );\n  }\n\n  /** Formats a line comment onto query */\n  private formatLineComment(token: Token) {\n    this.query.add(this.show(token), WS.NEWLINE, WS.INDENT);\n  }\n\n  /** Formats a block comment onto query */\n  private formatBlockComment(token: Token) {\n    this.query.add(WS.NEWLINE, WS.INDENT, this.indentComment(token.value), WS.NEWLINE, WS.INDENT);\n  }\n\n  /** Aligns comment to current indentation level */\n  private indentComment(comment: string): string {\n    return comment.replace(/\\n[ \\t]*/gu, '\\n' + this.indentation.getIndent() + ' ');\n  }\n\n  /**\n   * Formats a Reserved Command onto query, increasing indentation level where necessary\n   */\n  private formatCommand(token: Token) {\n    this.indentation.decreaseTopLevel();\n\n    this.query.add(WS.NEWLINE, WS.INDENT);\n\n    // indent tabular formats, except when preceding a (\n    if (isTabularStyle(this.cfg)) {\n      if (this.tokenLookAhead().value !== '(') {\n        this.indentation.increaseTopLevel();\n      }\n    } else {\n      this.indentation.increaseTopLevel();\n    }\n\n    if (this.currentNewline && !isTabularStyle(this.cfg)) {\n      this.query.add(this.show(token), WS.NEWLINE, WS.INDENT);\n    } else {\n      this.query.add(this.show(token), WS.SPACE);\n    }\n  }\n\n  /**\n   * Formats a Reserved Binary Command onto query, joining neighbouring tokens\n   */\n  private formatBinaryCommand(token: Token) {\n    const isJoin = /JOIN/i.test(token.value); // check if token contains JOIN\n    if (!isJoin || isTabularStyle(this.cfg)) {\n      // decrease for boolean set operators or in tabular mode\n      this.indentation.decreaseTopLevel();\n    }\n    if (isJoin) {\n      this.query.add(WS.NEWLINE, WS.INDENT, this.show(token), WS.SPACE);\n    } else {\n      this.query.add(WS.NEWLINE, WS.INDENT, this.show(token), WS.NEWLINE, WS.INDENT);\n    }\n  }\n\n  /**\n   * Formats a Reserved Keyword onto query, skipping AS if disabled\n   */\n  private formatKeyword(token: Token) {\n    if (isToken.AS(token) && this.aliasAs.shouldRemove()) {\n      return;\n    }\n\n    this.query.add(this.show(token), WS.SPACE);\n  }\n\n  /**\n   * Formats a Reserved Dependent Clause token onto query, supporting the keyword that precedes it\n   */\n  private formatDependentClause(token: Token) {\n    this.query.add(WS.NEWLINE, WS.INDENT, this.show(token), WS.SPACE);\n  }\n\n  // Formats ON and USING keywords\n  private formatJoinCondition(token: Token) {\n    this.query.add(this.show(token), WS.SPACE);\n  }\n\n  /**\n   * Formats an Operator onto query, following rules for specific characters\n   */\n  private formatOperator(token: Token) {\n    // special operator\n    if (token.value === ',') {\n      this.formatComma(token);\n      return;\n    } else if (token.value === ';') {\n      this.formatQuerySeparator(token);\n      return;\n    } else if (['$', '['].includes(token.value)) {\n      this.query.add(this.show(token));\n      return;\n    } else if ([':', ']'].includes(token.value)) {\n      this.query.add(WS.NO_SPACE, this.show(token), WS.SPACE);\n      return;\n    } else if (['.', '{', '}', '`'].includes(token.value)) {\n      this.query.add(WS.NO_SPACE, this.show(token));\n      return;\n    }\n\n    // other operators\n    // in dense operators mode do not trim whitespace if SELECT *\n    if (this.cfg.denseOperators && this.tokenLookBehind().type !== TokenType.RESERVED_COMMAND) {\n      this.query.add(WS.NO_SPACE, this.show(token));\n    } else {\n      this.query.add(this.show(token), WS.SPACE);\n    }\n  }\n\n  /**\n   * Formats a Logical Operator onto query, joining boolean conditions\n   */\n  private formatLogicalOperator(token: Token) {\n    // ignore AND when BETWEEN x [AND] y\n    if (isToken.AND(token) && isToken.BETWEEN(this.tokenLookBehind(2))) {\n      this.query.add(this.show(token), WS.SPACE);\n      return;\n    }\n\n    if (isTabularStyle(this.cfg)) {\n      this.indentation.decreaseTopLevel();\n    }\n\n    if (this.cfg.logicalOperatorNewline === 'before') {\n      if (this.currentNewline) {\n        this.query.add(WS.NEWLINE, WS.INDENT, this.show(token), WS.SPACE);\n      } else {\n        this.query.add(this.show(token), WS.SPACE);\n      }\n    } else {\n      // eslint-disable-next-line no-lonely-if\n      if (this.currentNewline) {\n        this.query.add(this.show(token), WS.NEWLINE, WS.INDENT);\n      } else {\n        this.query.add(this.show(token));\n      }\n    }\n  }\n\n  private formatBlockStart(token: Token) {\n    // Take out the preceding space unless there was whitespace there in the original query\n    // or another opening parens or line comment\n    const preserveWhitespaceFor = [\n      TokenType.BLOCK_START,\n      TokenType.LINE_COMMENT,\n      TokenType.OPERATOR,\n    ];\n    if (\n      token.whitespaceBefore?.length === 0 &&\n      !preserveWhitespaceFor.includes(this.tokenLookBehind().type)\n    ) {\n      this.query.add(WS.NO_SPACE, this.show(token));\n    } else if (!this.cfg.newlineBeforeOpenParen) {\n      this.query.add(WS.NO_NEWLINE, WS.SPACE, this.show(token));\n    } else {\n      this.query.add(this.show(token));\n    }\n    this.inlineBlock.beginIfPossible(this.tokens, this.index);\n\n    if (!this.inlineBlock.isActive()) {\n      this.indentation.increaseBlockLevel();\n      this.query.add(WS.NEWLINE, WS.INDENT);\n    }\n  }\n\n  private formatBlockEnd(token: Token) {\n    if (this.inlineBlock.isActive()) {\n      this.inlineBlock.end();\n      this.query.add(WS.NO_SPACE, this.show(token), WS.SPACE);\n    } else {\n      this.formatMultilineBlockEnd(token);\n    }\n  }\n\n  private formatCaseStart(token: Token) {\n    this.indentation.increaseBlockLevel();\n    if (this.cfg.multilineLists === 'always') {\n      this.query.add(this.show(token), WS.NEWLINE, WS.INDENT);\n    } else {\n      this.query.add(this.show(token), WS.SPACE);\n    }\n  }\n\n  private formatCaseEnd(token: Token) {\n    this.formatMultilineBlockEnd(token);\n  }\n\n  private formatMultilineBlockEnd(token: Token) {\n    this.indentation.decreaseBlockLevel();\n\n    if (isTabularStyle(this.cfg)) {\n      // +1 extra indentation step for the closing paren\n      this.query.add(WS.NEWLINE, WS.INDENT, WS.SINGLE_INDENT, this.show(token), WS.SPACE);\n    } else if (this.cfg.newlineBeforeCloseParen) {\n      this.query.add(WS.NEWLINE, WS.INDENT, this.show(token), WS.SPACE);\n    } else {\n      this.query.add(WS.NO_NEWLINE, WS.SPACE, this.show(token), WS.SPACE);\n    }\n  }\n\n  /**\n   * Formats a parameter placeholder item onto query, to be replaced with the value of the placeholder\n   */\n  private formatParameter(token: Token) {\n    this.query.add(this.params.get(token), WS.SPACE);\n  }\n\n  /**\n   * Formats a comma Operator onto query, ending line unless in an Inline Block\n   */\n  private formatComma(token: Token) {\n    if (\n      !this.inlineBlock.isActive() &&\n      !isToken.LIMIT(this.getPreviousReservedToken()) &&\n      this.currentNewline\n    ) {\n      this.query.add(WS.NO_SPACE, this.show(token), WS.NEWLINE, WS.INDENT);\n    } else {\n      this.query.add(WS.NO_SPACE, this.show(token), WS.SPACE);\n    }\n  }\n\n  private formatQuerySeparator(token: Token) {\n    if (this.cfg.newlineBeforeSemicolon) {\n      this.query.add(WS.NEWLINE, this.show(token));\n    } else {\n      this.query.add(WS.NO_SPACE, this.show(token));\n    }\n  }\n\n  private show(token: Token): string {\n    if (this.isTabularToken(token)) {\n      return toTabularFormat(this.showToken(token), this.cfg.indentStyle);\n    } else {\n      return this.showToken(token);\n    }\n  }\n\n  // These token types can be formatted in tabular style\n  private isTabularToken(token: Token): boolean {\n    return (\n      token.type === TokenType.RESERVED_LOGICAL_OPERATOR ||\n      token.type === TokenType.RESERVED_DEPENDENT_CLAUSE ||\n      token.type === TokenType.RESERVED_COMMAND ||\n      token.type === TokenType.RESERVED_BINARY_COMMAND\n    );\n  }\n\n  // don't call this directly, always use show() instead.\n  private showToken(token: Token): string {\n    if (isReserved(token)) {\n      switch (this.cfg.keywordCase) {\n        case 'preserve':\n          return equalizeWhitespace(token.text);\n        case 'upper':\n          return token.value;\n        case 'lower':\n          return token.value.toLowerCase();\n      }\n    } else {\n      return token.value;\n    }\n  }\n\n  /** Returns the latest encountered reserved keyword token */\n  public getPreviousReservedToken(): Token {\n    return this.previousReservedToken;\n  }\n\n  /** True when currently within SELECT command */\n  public isWithinSelect(): boolean {\n    return isToken.SELECT(this.previousCommandToken);\n  }\n\n  /** Fetches nth previous token from the token stream */\n  public tokenLookBehind(n = 1): Token {\n    return this.tokens[this.index - n] || EOF_TOKEN;\n  }\n\n  /** Fetches nth next token from the token stream */\n  public tokenLookAhead(n = 1): Token {\n    return this.tokens[this.index + n] || EOF_TOKEN;\n  }\n}\n"],"file":"StatementFormatter.js"}